"""methods pertaining to parties"""

# Import the Flask Framework

import json
import cgi
import party_scripts


def get_party_result(db, party_id):
	cursor = db.cursor()
	cursor.execute("""select rs.constituency_id,(votes - MY.max_votes) as lead,p.id as winning_party,rs.status,MY.max_votes as max_votes,ltw.party_id as ltw_party_id
        from results rs
        inner join candidate c on c.id = rs.candidate_id
        inner join constituency cs on cs.id = rs.constituency_id
        inner join latest_results as MY on MY.constituency_id = rs.constituency_id
        inner join party p on p.id = MY.party_id
        inner join candidate wc on wc.id = MY.candidate_id
        inner join last_time_winners ltw on ltw.constituency_id = cs.id
        where rs.active = true and rs.party_id = %s """, (party_id));
	basic_results = json.loads(aggregate_party_result_from_query_result(cursor.fetchall(), party_id))[0]
	vote_share = get_party_vote_percentage(db, party_id)
	basic_results['vote_percentage'] = vote_share
	return json.dumps(basic_results)


def get_coalition_parties(db, coalition_id):
	cursor = db.cursor()
	cursor.execute("Select id,name,symbol,shortform from party where coalition_id = %s", coalition_id)
	results = []
	for row in cursor.fetchall():
		results.append({"party_id": row[0],
		                "symbol": row[2],
		                "name": row[1],
		                "shortform": row[3]
		})
	return json.dumps(results)

def get_coalition_state_parties(db, coalition_id,state_id):
	cursor = db.cursor()
	cursor.execute("""SELECT distinct p.* FROM resultdayanalysis.results r
		inner join constituency c on c.id = r.constituency_id
		inner join party p on p.id = r.party_id
		where c.state_id = %s and p.coalition_id =%s;
	               """, (state_id,coalition_id))
	results = []
	for row in cursor.fetchall():
		results.append({"party_id": row[0],
		                "symbol": row[2],
		                "name": row[1],
		                "shortform": row[3]
		})
	return json.dumps(results)



def get_coalition_result(db, coalition_id):
	parties = json.loads(get_coalition_parties(db, coalition_id))

	wins = 0
	leads = 0
	swing = 0
	vote_percentage = 0
	results = []
	for party in parties:
		basic_result = json.loads(get_party_result(db, party['party_id']))
		results.append({"party_id":party['party_id'],
		                "party_name":party['name'],
		                "wins":basic_result['wins'],
						"leads":basic_result['leads'],
		                "total_ahead":(basic_result['wins']+basic_result['leads']),
						"swing":basic_result['swing'],
						"vote_percentage":basic_result['vote_percentage']
						})
	return json.dumps(results)

def get_coalition_state_result(db, coalition_id,state_id):
	parties = json.loads(get_coalition_state_parties(db, coalition_id,state_id))

	wins = 0
	leads = 0
	swing = 0
	vote_percentage = 0
	results = []
	for party in parties:
		basic_result = json.loads(get_party_result_by_state(db, party['party_id'],state_id))
		results.append({"party_id":party['party_id'],
		                "party_name":party['name'],
		                "wins":basic_result['wins'],
		                "leads":basic_result['leads'],
		                "total_ahead":(basic_result['wins']+basic_result['leads']),
		                "swing":basic_result['swing'],
		                "vote_percentage":basic_result['vote_percentage']
		})
	return json.dumps(results)




def get_party_statewise_result(db, party_id):
	"""
	Summary of results as
	state,wins,leads,swing,vote_percentage,total
	:param party_id: party id
	"""



def get_party_statewise_result(db, party_id):
	"""
	Summary of results as
	state,wins,leads,swing,vote_percentage,total
	:param party_id: party id
	"""
	statelist = json.loads(get_constituency_count_for_states(db))
	results = []
	for sl in statelist:
		basic_summary = json.loads(get_party_result_by_state(db, int(party_id), sl['state_id']))
		if basic_summary['vote_percentage'] > 0:
			results.append({"state": sl['state_name'],
			                "state_id": sl['state_id'],
			                "wins": basic_summary['wins'],
			                "leads": basic_summary['leads'],
			                "total_ahead": (basic_summary['wins'] + basic_summary['leads']),
			                "swing": basic_summary['swing'],
			                "vote_percentage": basic_summary['vote_percentage'],
			                "total": sl['pc_count']})
		else:
			pass
	return json.dumps(results)

def get_coalition_statewise_result(db,coalition_id):
	parties = json.loads(get_coalition_parties(db, coalition_id))

	statelist = json.loads(get_constituency_count_for_states(db))
	results = []
	for sl in statelist:
		wins =0
		leads = 0
		swing =0
		vote_percentage = 0
		for party in parties:
			partystatewiseResults = json.loads(get_party_result_by_state(db,party['party_id'],sl['state_id']))
			wins =wins+ partystatewiseResults['wins']
			leads =leads+ partystatewiseResults['leads']
			swing = swing+partystatewiseResults['swing']
			vote_percentage=vote_percentage+float(partystatewiseResults['vote_percentage'])
		if vote_percentage > 0:
			results.append({"state": sl['state_name'],
							"state_id": sl['state_id'],
							"wins": wins,
							"leads": leads,
							"total_ahead": (wins+leads),
							"swing": swing,
							"vote_percentage": round(vote_percentage,2),
							"total": sl['pc_count']})
		else:
			pass

	return json.dumps(results)




def get_party_result_by_state(db, party_id, state_id):
	cursor = db.cursor()
	cursor.execute("""select rs.constituency_id,(votes - MY.max_votes) as lead,p.id as winning_party,rs.status,MY.max_votes as max_votes,ltw.party_id as ltw_party_id
        from results rs
        inner join candidate c on c.id = rs.candidate_id
        inner join constituency cs on cs.id = rs.constituency_id
        inner join latest_results as MY on MY.constituency_id = rs.constituency_id
        inner join party p on p.id = MY.party_id
        inner join candidate wc on wc.id = MY.candidate_id
        inner join last_time_winners ltw on ltw.constituency_id = cs.id
        where rs.active = true and rs.party_id = %s and cs.state_id = %s""", (party_id, state_id));

	basic_summary = json.loads(aggregate_party_result_from_query_result(cursor.fetchall(), party_id))[0]
	vote_percentage = json.loads(get_vote_percentage_for_party_state(db, party_id, state_id))
	party_result = dict([('wins', basic_summary['wins']),
	                     ("leads", basic_summary['leads']),
	                     ("swing", basic_summary['swing']),
	                     ("vote_percentage", vote_percentage)])

	return json.dumps(party_result)


def get_vote_percentage_for_party_state(db, party_id, state_id):
	cursor = db.cursor()
	cursor.execute("""select sum(r.votes),r.party_id from results as r
        inner join constituency c on c.id = r.constituency_id
        where c.state_id = %s group by r.party_id""", (state_id))
	return aggregate_vote_share_for_query_result(cursor.fetchall(), party_id)


def get_party_vote_percentage(db, party_id):
	cursor = db.cursor()
	cursor.execute("""select sum(r.votes),r.party_id from results as r
         group by r.party_id""")
	return aggregate_vote_share_for_query_result(cursor.fetchall(), party_id)


def get_party_list(db, dummy):
	cursor = db.cursor()
	cursor.execute('SELECT id, name, shortform from party')
	partyList = []
	for row in cursor.fetchall():
		partyList.append(dict([('id', row[0]),
		                       ('name', cgi.escape(row[1])),
		                       ('shortform', row[2])]))
	return json.dumps(partyList)

def get_coalition(db,coalition_id):
	cursor = db.cursor()
	cursor.execute(
		"SELECT p.id, p.name, p.shortform,p.symbol from coalition p  where p.id = %s;",coalition_id)
	row = cursor.fetchone()
	coalition = dict([('id', row[0]),
	              ('name', cgi.escape(row[1])),
	              ('symbol', row[3]),
	              ('shortform', cgi.escape(row[2]))])
	return json.dumps(coalition)


def get_party(db, party_id):
	cursor = db.cursor()
	cursor.execute(
		'SELECT p.id, p.name, p.shortform,p.symbol,c.name as coalition,p.colour from party p inner join coalition c on c.id = p.coalition_id where p.id = ' + party_id + ';')
	row = cursor.fetchone()
	party = dict([('id', row[0]),
	              ('name', cgi.escape(row[1])),
	              ('symbol', row[3]),
	              ('coalition', cgi.escape(row[4])),
	              ('colour', row[5]),
	              ('shortform', cgi.escape(row[2]))])
	return json.dumps(party)


def get_constituency_count_for_states(db):
	"""
	:rtype : JSON object with array of {state_id:"value",state_name:"value",pc_count="value"}
	"""
	cursor = db.cursor()
	cursor.execute(
		'select count(c.id),s.name,s.id from constituency c inner join state s on s.id = c.state_id group by s.id order by count(c.id);');
	rsults = []
	for row in cursor.fetchall():
		rsults.append({"state_id": row[2], "state_name": row[1], "pc_count": row[0]})
	return json.dumps(rsults);



def get_party_state_detailed_result_undeclared(db, party_id, state_id):
	results = []
	lead_cursor = db.cursor()
	lead_cursor.execute(party_scripts.get_party_leads_sql_string_for_state(party_id, state_id))
	for row in lead_cursor.fetchall():
		results.append({
		"candidate_id": row[0],
		"candidate_name": row[1],
		"constituency_name": row[3],
		"constituency_id": row[2],
		"votes": row[5],
		"lead": row[6],
		"loosing_candidate_name": row[8],
		"loosing_party_name": row[9],
		"status": "LEAD"
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_party_trails_sql_string_for_state(party_id, state_id,"COUNTING"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "TRAIL"
		})
	return json.dumps(results)


def get_party_state_detailed_result_declared(db, party_id, state_id):
	results = []
	win_cursor= db.cursor()
	win_cursor.execute(party_scripts.get_party_wins_sql_string_for_state(party_id,state_id))

	for row in win_cursor.fetchall():
		results.append({
		"candidate_id":row[0],
		"candidate_name":row[1],
		"constituency_name":row[3],
		"constituency_id":row[2],
		"votes":row[5],
		"lead":row[6],
		"loosing_candidate_name":row[8],
		"loosing_party_name":row[9],
		"status":"WIN"
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_party_trails_sql_string_for_state(party_id, state_id,"DECLARED"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "LOST"
		})

	return json.dumps(results)

def get_coalition_state_detailed_result_undeclared(db,coalition_id,state_id):
	results = []
	lead_cursor = db.cursor()
	lead_cursor.execute(party_scripts.get_coalition_leads_sql_string_for_state(coalition_id,state_id))

	for row in lead_cursor.fetchall():
		results.append({
		"candidate_id": row[0],
		"candidate_name": row[1],
		"constituency_name": row[3],
		"constituency_id": row[2],
		"votes": row[5],
		"lead": row[6],
		"loosing_candidate_name": row[8],
		"loosing_party_name": row[9],
		"status": "LEAD",
		"party_name":row[11]
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_coalition_trails_sql_string_for_state(coalition_id,state_id,"COUNTING"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "TRAIL",
		"party_name":row[10]
		})

	return json.dumps(results)

def get_coalition_detailed_result_undeclared(db,coalition_id):
	results = []
	lead_cursor = db.cursor()
	lead_cursor.execute(party_scripts.get_coalition_leads_sql_string(coalition_id))

	for row in lead_cursor.fetchall():
		results.append({
		"candidate_id": row[0],
		"candidate_name": row[1],
		"constituency_name": row[3],
		"constituency_id": row[2],
		"votes": row[5],
		"lead": row[6],
		"loosing_candidate_name": row[8],
		"loosing_party_name": row[9],
		"status": "LEAD",
		"party_name":row[11]
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_coalition_trails_sql_string(coalition_id,"COUNTING"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "TRAIL",
		"party_name":row[10]
		})

	return json.dumps(results)

def get_coalition_state_detailed_result_declared(db,coalition_id,state_id):
	results = []

	win_cursor= db.cursor()
	win_cursor.execute(party_scripts.get_coalition_wins_sql_string_for_state(coalition_id,state_id))

	for row in win_cursor.fetchall():
		results.append({
		"candidate_id":row[0],
		"candidate_name":row[1],
		"constituency_name":row[3],
		"constituency_id":row[2],
		"votes":row[5],
		"lead":row[6],
		"loosing_candidate_name":row[8],
		"loosing_party_name":row[9],
		"status":"WIN",
		"party_name":row[11]
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_coalition_trails_sql_string_for_state(coalition_id,state_id,"DECLARED"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "LOST",
		"party_name":row[10]
		})
	return json.dumps(results)

def get_coalition_detailed_result_declared(db,coalition_id):
	results = []

	win_cursor= db.cursor()
	win_cursor.execute(party_scripts.get_coalition_wins_sql_string(coalition_id))

	for row in win_cursor.fetchall():
		results.append({
		"candidate_id":row[0],
		"candidate_name":row[1],
		"constituency_name":row[3],
		"constituency_id":row[2],
		"votes":row[5],
		"lead":row[6],
		"loosing_candidate_name":row[8],
		"loosing_party_name":row[9],
		"status":"WIN",
		"party_name":row[11]
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_coalition_trails_sql_string(coalition_id,"DECLARED"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "LOST",
		"party_name":row[10]
		})
	return json.dumps(results)



def get_party_detailed_result_declared(db, party_id):
	results = []

	win_cursor= db.cursor()
	win_cursor.execute(party_scripts.get_party_wins_sql_string(party_id))

	for row in win_cursor.fetchall():
		results.append({
		"candidate_id":row[0],
		"candidate_name":row[1],
		"constituency_name":row[3],
		"constituency_id":row[2],
		"votes":row[5],
		"lead":row[6],
		"loosing_candidate_name":row[8],
		"loosing_party_name":row[9],
		"status":"WIN"
		})


	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_party_trails_sql_string(party_id,"DECLARED"))

	for row in trail_cursor.fetchall():
		results.append({
		"constituency_id": row[0],
		"constituency_name": row[1],
		"candidate_id": row[2],
		"candidate_name": row[3],
		"votes": row[5],
		"lead": row[4],
		"winning_party_name": row[6],
		"winning_candidate_name": row[8],
		"status": "LOST"
		})

	return json.dumps(results)

def get_party_detailed_result_undeclared(db, party_id):
	results = []

	lead_cursor = db.cursor()
	lead_cursor.execute(party_scripts.get_party_leads_sql_string(party_id))

	for row in lead_cursor.fetchall():
		results.append({
			"candidate_id": row[0],
			"candidate_name": row[1],
			"constituency_name": row[3],
			"constituency_id": row[2],
			"votes": row[5],
			"lead": row[6],
			"loosing_candidate_name": row[8],
			"loosing_party_name": row[9],
			"status": "LEAD"
		})

	trail_cursor = db.cursor()
	trail_cursor.execute(party_scripts.get_party_trails_sql_string(party_id,"COUNTING"))

	for row in trail_cursor.fetchall():
		results.append({
			"constituency_id": row[0],
			"constituency_name": row[1],
			"candidate_id": row[2],
			"candidate_name": row[3],
			"votes": row[5],
			"lead": row[4],
			"winning_party_name": row[6],
			"winning_candidate_name": row[8],
			"status": "TRAIL"
		})

	return json.dumps(results)


def aggregate_party_result_from_query_result(rows, party_id):
	"""

    Takes the results for a region and calculates wincount, leadcount and swing for that region.
    :param rows:
    :param party_id:
    :return:
    """
	wincount = 0
	leadcount = 0
	swingcount = 0

	for row in rows:

		if row[1] == 0:
			if row[3] == 'DECLARED':
				wincount = wincount + 1
			else:
				leadcount = leadcount + 1

			# if the party is winning/leading now, but hasn't won the last time - then the swing count will get added by one.
			if row[5] != long(party_id):
				swingcount = swingcount + 1
			else:
				pass
		else:
			# if the party isn't leading/winning now - and won the last time, then swing count will reduce by 1
			if row[5] == long(party_id):
				swingcount -= 1
			else:
				pass
	result = []
	result.append({'wins': wincount, 'leads': leadcount, 'swing': swingcount})
	return json.dumps(result)


def aggregate_vote_share_for_query_result(rows, party_id):
	"""

        Totals the votes received for the extent of the query and
        gives the voting percentage for a particular party.
    :param rows:
    :param party_id:
    :return:
    """
	totalvotes = 0
	party_vote = 0
	for row in rows:
		totalvotes = totalvotes + row[0]
		if row[1] == long(party_id):
			party_vote = row[0]
		else:
			pass
	if totalvotes != 0:
		vote_share = (party_vote / totalvotes) * 100
		return str(round(vote_share, 2))
	else:
		return '0'